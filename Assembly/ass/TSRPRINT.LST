Turbo Assembler	 Version 4.1	    12/09/03 08:44:33	    Page 1
E:\PROGRAMS\ASSEMBLY\ASS\TSRPRINT.asm



      1				     jumps
      2				     ;################MACROS########################
      3				     put macro m1
      4					     lea     dx,m1
      5					     mov     ah,09h
      6					     int     21h
      7				     endm
      8	      =0099		     OURID   EQU     99H
      9				     ;############################################
     10	0000			     .model  tiny
     11	0000			     .code
     12				     org     100h
     13	0100			     start:
     14	0100  E9 01E0			     jmp     main
     15	0103  00000000		     old9    dd	     0	     ;this is not transient
     16	0107  00000000		     old2f   dd	     0
     17	010B  0000		     psp     dw	     0
     18				     ;#######################INT9################
     19	010D			     int9:
     20	010D  FA			     cli
     21	010E  50 53 51 52 56 57	1E+	     push    ax	bx cx dx si di ds es
     22	      06
     23
     24					    ; mov     ax,40h
     25					   ;  push    ax
     26					   ;  pop     es
     27					   ;  mov     bx,17h
     28					   ;  mov     al,es:[bx]
     29
     30	0116  E4 60			     in	     al,60h
     31	0118  3C 19			     cmp     al,19h
     32	011A  75 02			     jnz     done
     33
     34	011C  CD 05			     int     05h
     35	011E			     done:
     36	011E  07 1F 5F 5E 5A 59	5B+	     pop     es	ds di si dx cx bx ax
     37	      58
     38	0126  FB			     sti
     39	0127  2E: FF 2E	0103r		     jmp     cs:old9
     40
     41				     ;#####################int 2f#########################
     42	012C			     int2f:
     43	012C  3D 0000			     cmp     ax,0
     44	012F  74 0A			     je	     query
     45	0131  3D 0001			     cmp     ax,1
     46	0134  74 09			     je	     remove
     47	0136  2E: FF 2E	0107r		     jmp     cs:old2f	     ;any other
     48	013B			     query:
     49	013B  B8 0099			     mov     ax,ourid
     50	013E  CF			     iret
     51
     52	013F			     remove:
     53
     54	013F  B8 3509			     mov     ax,3509h
     55	0142  CD 21			     int     21h	     ;get vector
     56	0144  81 FB 010Dr		     cmp     bx,offset int9
     57	0148  75 48			     jne     another
Turbo Assembler	 Version 4.1	    12/09/03 08:44:33	    Page 2
E:\PROGRAMS\ASSEMBLY\ASS\TSRPRINT.asm



     58
     59	014A  B8 352F			     mov     ax,352fh
     60	014D  CD 21			     int     21h
     61	014F  81 FB 012Cr		     cmp     bx,offset int2f
     62	0153  75 3D			     jne     another
     63
     64	0155  FA			     cli
     65	0156  1E			     push    ds
     66
     67	0157  2E: 8B 16	0103r		     mov     dx,word ptr cs:[old9]    ;since this is isr only cs holds the segment address  +
     68				     of	tsr
     69	015C  2E: 8E 1E	0105r		     mov     ds,word ptr cs:[old9+2]
     70	0161  B8 2509			     mov     ax,2509h
     71	0164  CD 21			     int     21h
     72
     73	0166  2E: 8B 16	0107r		     mov     dx,word ptr cs:[old2f]
     74	016B  2E: 8E 1E	0109r		     mov     ds,word ptr cs:[old2f+2]
     75	0170  B8 252F			     mov     ax,252fh
     76	0173  CD 21			     int     21h
     77
     78	0175  2E: 8E 06	010Br		     mov     es,word ptr cs:PSP
     79	017A  26: 8E 06	002C		     mov     es,es:word	ptr [2Ch]     ;Get address of environment block.
     80	017F  B4 49			     mov     ah,49h		      ;Deallocate the memory taken up by it!
     81	0181  CD 21			     int     21h
     82
     83	0183  2E: 8E 06	010Br		     mov     es,word ptr cs:PSP		 ;Deallocate the memory	taken up by the	PSP
     84	0188  B8 4900			     mov     ax,4900h
     85	018B  CD 21			     int     21h
     86
     87	018D  1F			     pop     ds
     88	018E  33 C0			     xor     ax,ax		     ;return 0 success:)
     89
     90	0190  FB			     sti
     91	0191  CF			     iret
     92
     93	0192			     another:
     94					     put     anot
1    95	0192  BA 02CEr			     lea     dx,anot
1    96	0195  B4 09			     mov     ah,09h
1    97	0197  CD 21			     int     21h
     98	0199  CB			     retf
     99				     ;#######################################################
    100				     ;	     transient section
    101				     ;######################################################
    102	019A			     trans:
    103	019A  50 72 69 6E 74 20	53+  msg0    db	     "Print Screen TSR"
    104	      63 72 65 65 6E 20	54+
    105	      53 52
    106	01AA  0A 0D 57 72 69 74	74+	     db	     10,13,"Written in asm by Madhur"
    107	      65 6E 20 69 6E 20	61+
    108	      73 6D 20 62 79 20	4D+
    109	      61 64 68 75 72
    110	01C4  0A 0D 0A 0D 55 73	61+	     db	     10,13,10,13,"Usage: tsrprint [option]"
    111	      67 65 3A 20 74 73	72+
    112	      70 72 69 6E 74 20	5B+
    113	      6F 70 74 69 6F 6E	5D
    114	01E0  0A 0D 2F 69 3A 20	49+	     db	     10,13,"/i:	Install"
Turbo Assembler	 Version 4.1	    12/09/03 08:44:33	    Page 3
E:\PROGRAMS\ASSEMBLY\ASS\TSRPRINT.asm



    115	      6E 73 74 61 6C 6C
    116	01ED  0A 0D 2F 75 3A 20	55+	     db	     10,13,"/u:	Uninstall"
    117	      6E 69 6E 73 74 61	6C+
    118	      6C
    119	01FC  0A 0D 2F 3F 3A 20	44+	     db	     10,13,"/?:	Display	this",10,13,"$"
    120	      69 73 70 6C 61 79	20+
    121	      74 68 69 73 0A 0D	24
    122
    123	0211  54 53 52 20 53 75	63+  load    db	     "TSR Successfully Loaded",10,13,"$"
    124	      63 65 73 73 66 75	6C+
    125	      6C 79 20 4C 6F 61	64+
    126	      65 64 0A 0D 24
    127	022B  54 53 52 20 41 6C	72+  loaded  db	     "TSR Already Loaded",10,13,"$"
    128	      65 61 64 79 20 4C	6F+
    129	      61 64 65 64 0A 0D	24
    130	0240  54 53 52 20 53 75	63+  unload  db	     "TSR Successfully Unloaded",10,13,"$"
    131	      63 65 73 73 66 75	6C+
    132	      6C 79 20 55 6E 6C	6F+
    133	      61 64 65 64 0A 0D	24
    134
    135	025C  49 6E 76 61 6C 69	64+  inval   db	     "Invalid Command line arguments"
    136	      20 43 6F 6D 6D 61	6E+
    137	      64 20 6C 69 6E 65	20+
    138	      61 72 67 75 6D 65	6E+
    139	      74 73
    140	027A  0A 0D 53 65 65 20	2F+	     db	     10,13,"See	/? for more",10,13,"$"
    141	      3F 20 66 6F 72 20	6D+
    142	      6F 72 65 0A 0D 24
    143
    144	028E  54 53 52 20 6E 6F	74+  notl    db	     "TSR not loaded in	memory",10,13,"$"
    145	      20 6C 6F 61 64 65	64+
    146	      20 69 6E 20 6D 65	6D+
    147	      6F 72 79 0A 0D 24
    148	02A9  54 53 52 20 72 65	74+  err1    db	     "TSR returned error while unloading",10,13,"$"
    149	      75 72 6E 65 64 20	65+
    150	      72 72 6F 72 20 77	68+
    151	      69 6C 65 20 75 6E	6C+
    152	      6F 61 64 69 6E 67	0A+
    153	      0D 24
    154	02CE  41 6E 6F 74 68 65	72+  anot    db	     "Another TSR Loaded",10,13,"$"
    155	      20 54 53 52 20 4C	6F+
    156	      61 64 65 64 0A 0D	24
    157	02E3			     main:
    158	02E3  BE 0080			     mov     si,80h		     ;get the cmd tail
    159	02E6			     checkcmd:
    160	02E6  46			     inc     si
    161	02E7  8A 04			     mov     al,[si]
    162	02E9  3C 20			     cmp     al,' '
    163	02EB  74 F9			     je	     checkcmd
    164	02ED  3C 0D			     cmp     al,13
    165	02EF  74 19			     je	     help
    166	02F1  3C 2F			     cmp     al,'/'
    167	02F3  74 02			     je	     checkopt
    168	02F5  EB 1D			     jmp     invalid		     ;if not space or enter or /= invalid
    169
    170	02F7			     checkopt:
    171	02F7  8B 04			     mov     ax,[si]
Turbo Assembler	 Version 4.1	    12/09/03 08:44:33	    Page 4
E:\PROGRAMS\ASSEMBLY\ASS\TSRPRINT.asm



    172	02F9  80 FC 3F			     cmp     ah,'?'
    173	02FC  74 0C			     je	     help		     ;disp help
    174	02FE  80 FC 69			     cmp     ah,'i'
    175	0301  74 1B			     je	     install		     ;do instal
    176	0303  80 FC 75			     cmp     ah,'u'
    177	0306  74 28			     je	     uninstall		     ;remove
    178	0308  EB 0A			     jmp     invalid
    179
    180	030A			     help:
    181					     put     msg0
1   182	030A  BA 019Ar			     lea     dx,msg0
1   183	030D  B4 09			     mov     ah,09h
1   184	030F  CD 21			     int     21h
    185	0311  E9 008D			     jmp     quit
    186
    187	0314			     invalid:
    188					     put     inval
1   189	0314  BA 025Cr			     lea     dx,inval
1   190	0317  B4 09			     mov     ah,09h
1   191	0319  CD 21			     int     21h
    192	031B  E9 0083			     jmp     quit
    193
    194
    195	031E			     install:
    196	031E  33 C0			     xor     ax,ax
    197	0320  CD 2F			     int     2fh
    198	0322  3D 0099			     cmp     ax,OURID
    199	0325  75 37			     jne     loadit	     ;if ax!=99,tsr not	loaded
    200
    201					     put     loaded
1   202	0327  BA 022Br			     lea     dx,loaded
1   203	032A  B4 09			     mov     ah,09h
1   204	032C  CD 21			     int     21h
    205	032E  EB 71			     jmp     quit
    206
    207	0330			     uninstall:
    208	0330  33 C0			     xor     ax,ax	     ;query presence
    209	0332  CD 2F			     int     2fh
    210	0334  3D 0099			     cmp     ax,ourid
    211	0337  74 09			     je	     remove1	     ;yes tsr present
    212
    213					     put     notl
1   214	0339  BA 028Er			     lea     dx,notl
1   215	033C  B4 09			     mov     ah,09h
1   216	033E  CD 21			     int     21h
    217	0340  EB 5F			     jmp     quit
    218
    219	0342			     remove1:
    220	0342  B8 0001			     mov     ax,1
    221	0345  CD 2F			     int     2fh	     ;send remove message
    222	0347  3D 0000			     cmp     ax,0	     ;get success status
    223	034A  75 09			     jnz     error
    224					     put     unload
1   225	034C  BA 0240r			     lea     dx,unload
1   226	034F  B4 09			     mov     ah,09h
1   227	0351  CD 21			     int     21h
    228	0353  EB 4C			     jmp     quit	     ;quit this	program
Turbo Assembler	 Version 4.1	    12/09/03 08:44:33	    Page 5
E:\PROGRAMS\ASSEMBLY\ASS\TSRPRINT.asm



    229
    230	0355			     error:
    231					     put     err1
1   232	0355  BA 02A9r			     lea     dx,err1
1   233	0358  B4 09			     mov     ah,09h
1   234	035A  CD 21			     int     21h
    235	035C  EB 43			     jmp     quit
    236
    237				     ;##########################INIT#######################
    238	035E			     loadit:
    239	035E  FA			     cli
    240
    241	035F  B4 51			     mov     ah,51h
    242	0361  CD 21			     int     21h
    243	0363  89 1E 010Br		     mov     word ptr PSP,bx  ;Save the	PSP base address
    244
    245	0367  B8 3509			     mov     ax,3509h
    246	036A  CD 21			     int     21h	     ;get vector
    247	036C  89 1E 0103r		     mov     word ptr [old9],bx
    248	0370  8C 06 0105r		     mov     word ptr [old9+2],es
    249
    250	0374  B8 352F			     mov     ax,352fh
    251	0377  CD 21			     int     21h
    252	0379  89 1E 0107r		     mov     word ptr [old2f],bx
    253	037D  8C 06 0109r		     mov     word ptr [old2f+2],es
    254
    255	0381  B8 2509			     mov     ax,2509h
    256	0384  BA 010Dr			     lea     dx,int9
    257	0387  CD 21			     int     21h	     ;set vector
    258					     p
**Error** E:\PROGRAMS\ASSEMBLY\ASS\TSRPRINT.asm(197) Illegal instruction
    259	0389  B8 252F			     mov     ax,252fh
    260	038C  BA 012Cr			     lea     dx,int2f
    261	038F  CD 21			     int     21h
    262
    263					     put     load
1   264	0391  BA 0211r			     lea     dx,load
1   265	0394  B4 09			     mov     ah,09h
1   266	0396  CD 21			     int     21h
    267
    268	0398  B8 3100			     mov     ax,3100h
    269	039B  BA 019Ar			     lea     dx,trans
    270
    271	039E  FB			     sti
    272	039F  CD 21			     int     21h
    273							     ;become tsr
    274	03A1			     quit:
    275					     .exit
1   276	03A1  B4 4C			     MOV     AH,4Ch
1   277	03A3  CD 21			     INT     21h
    278				     end     start
Turbo Assembler	 Version 4.1	    12/09/03 08:44:33	    Page 6
Symbol Table




Symbol Name		Type   Value			   Cref	(defined at #)

??DATE			Text   "12/09/03"
??FILENAME		Text   "TSRPRINT"
??TIME			Text   "08:44:33"
??VERSION		Number 040A
@32BIT			Text   0			   #10
@CODE			Text   DGROUP			   #10
@CODESIZE		Text   0			   #10
@CPU			Text   0101H
@CURSEG			Text   _TEXT			   #11
@DATA			Text   DGROUP			   #10
@DATASIZE		Text   0			   #10
@FILENAME		Text   TSRPRINT
@INTERFACE		Text   000H			   #10
@MODEL			Text   1			   #10
@STACK			Text   DGROUP			   #10
@WORDSIZE		Text   2			   #11
ANOT			Byte   DGROUP:02CE		   95  #154
ANOTHER			Near   DGROUP:0192		   57  62  #93
CHECKCMD		Near   DGROUP:02E6		   #159	 163
CHECKOPT		Near   DGROUP:02F7		   167	#170
DONE			Near   DGROUP:011E		   32  #35
ERR1			Byte   DGROUP:02A9		   #148	 232
ERROR			Near   DGROUP:0355		   223	#230
HELP			Near   DGROUP:030A		   165	173  #180
INSTALL			Near   DGROUP:031E		   175	#195
INT2F			Near   DGROUP:012C		   #42	61  260
INT9			Near   DGROUP:010D		   #19	56  256
INVAL			Byte   DGROUP:025C		   #135	 189
INVALID			Near   DGROUP:0314		   168	178  #187
LOAD			Byte   DGROUP:0211		   #123	 264
LOADED			Byte   DGROUP:022B		   #127	 202
LOADIT			Near   DGROUP:035E		   199	#238
MAIN			Near   DGROUP:02E3		   14  #157
MSG0			Byte   DGROUP:019A		   #103	 182
NOTL			Byte   DGROUP:028E		   #144	 214
OLD2F			Dword  DGROUP:0107		   #16	47  73	74  252	 253
OLD9			Dword  DGROUP:0103		   #15	39  67	69  247	 248
OURID			Number 0099			   #8  49  198	210
PSP			Word   DGROUP:010B		   #17	78  83	243
QUERY			Near   DGROUP:013B		   44  #48
QUIT			Near   DGROUP:03A1		   185	192  205  217  228  235	 #274
REMOVE			Near   DGROUP:013F		   46  #52
REMOVE1			Near   DGROUP:0342		   211	#219
START			Near   DGROUP:0100		   #13	278
TRANS			Near   DGROUP:019A		   #102	 269
UNINSTALL		Near   DGROUP:0330		   177	#207
UNLOAD			Byte   DGROUP:0240		   #130	 225

Macro Name						   Cref	(defined at #)

PUT							   #3  94  181	188  201  213  224  231	 263
Turbo Assembler	 Version 4.1	    12/09/03 08:44:33	    Page 7
Symbol Table




Groups & Segments	Bit Size Align	Combine	Class	   Cref	(defined at #)

DGROUP			Group				   #10	10
  _DATA			16  0000 Word	Public	DATA	   #10
  _TEXT			16  03A5 Word	Public	CODE	   #10	#11
Turbo Assembler	 Version 4.1	    12/09/03 08:44:33	    Page 8
Error Summary



	p
**Error** E:\PROGRAMS\ASSEMBLY\ASS\TSRPRINT.asm(197) Illegal instruction
