Turbo Assembler	 Version 4.1	    11/22/03 20:45:03	    Page 1
E:\PROGRAMS\ASSEMBLY\ASS\FAT.asm



      1				     ;PROGRAM TO READ THE FAT CHAIN
      2				     ;MADHUR AHUJA
      3				     ;TE IT
      4
      5				     ;SECTOR
      6				     ;0		     1-9(9)		     10-18(9)		     19-32(14)
      7				     ;boot sector    first fat copy	     second fat	copy	     directory
      8
      9				     jumps
     10				     locals
     11	0000			     .model small
     12	0000			     .stack
     13	0000			     .data
     14	0000  1C00*(00)		     dirbuff db	     512*14 dup(0)
     15	1C00  1200*(00)		     fatbuff db	     512*9 dup(0)
     16	2E00  0D 00 0D*(00)	     fname   db	     13,0,13 dup(0)
     17	2E0F  0C 00 0C*(20)	     actname db	     12,0,12 dup(32)
     18	2E1D  03		     cnt     db	     3h
     19	2E1E  0000		     clust   dw	     0
     20
     21	2E20  01		     dotflag db	     1
     22	2E21  0A 0D 52 65 61 64	69+  msg0    db	     10,13,"Reading FAT	and Directory...$"
     23	      6E 67 20 46 41 54	20+
     24	      61 6E 64 20 44 69	72+
     25	      65 63 74 6F 72 79	2E+
     26	      2E 2E 24
     27	2E40  30 25 24 35 30 25	24+  msg01   db	     "0%$50%$100%$"
     28	      31 30 30 25 24
     29	2E4C  0A 0D 45 6E 74 65	72+  msg1    db	     10,13,"Enter the filename:$"
     30	      20 74 68 65 20 66	69+
     31	      6C 65 6E 61 6D 65	3A+
     32	      24
     33	2E62  0A 0D 46 61 74 20	43+  msg2    db	     10,13,"Fat	Chain:$"
     34	      68 61 69 6E 3A 24
     35	2E6F  0A 0D 45 6E 64 20	6F+  msg3    db	     10,13,"End	of File:$"
     36	      66 20 46 69 6C 65	3A+
     37	      24
     38
     39	2E7E  0A 0D 0A 0D 44 69	73+  err1    db	     10,13,10,13,"Disk not found..."
     40	      6B 20 6E 6F 74 20	66+
     41	      6F 75 6E 64 2E 2E	2E
     42	2E93  0A 0D 49 6E 73 65	72+	     db	     10,13,"Insert the disk and	press enter...$"
     43	      74 20 74 68 65 20	64+
     44	      69 73 6B 20 61 6E	64+
     45	      20 70 72 65 73 73	20+
     46	      65 6E 74 65 72 2E	2E+
     47	      2E 24
     48	2EB8  0A 0D 55 6E 6B 6E	6F+  err2    db	     10,13,"Unknown Error:Exiting...$"
     49	      77 6E 20 45 72 72	6F+
     50	      72 3A 45 78 69 74	69+
     51	      6E 67 2E 2E 2E 24
     52	2ED3  0A 0D 46 69 6C 65	20+  err3    db	     10,13,"File not found on the Disk$"
     53	      6E 6F 74 20 66 6F	75+
     54	      6E 64 20 6F 6E 20	74+
     55	      68 65 20 44 69 73	6B+
     56	      24
     57	2EF0  0A 0D 24		     crlf1   db	     10,13,"$"
Turbo Assembler	 Version 4.1	    11/22/03 20:45:03	    Page 2
E:\PROGRAMS\ASSEMBLY\ASS\FAT.asm



     58
     59				     put     macro m1
     60					     lea     dx,m1
     61					     mov     ah,9h
     62					     int     21h
     63				     endm
     64
     65	2EF3			     .code
     66	0000			     start:
     67	0000  B8 0000s			     mov     ax,@data
     68	0003  8E D8			     mov     ds,ax
     69	0005  8E C0			     mov     es,ax
     70
     71	0007			     tryagain:
     72					     put     msg0
1    73	0007  BA 2E21r			     lea     dx,msg0
1    74	000A  B4 09			     mov     ah,9h
1    75	000C  CD 21			     int     21h
     76					     put     msg01
1    77	000E  BA 2E40r			     lea     dx,msg01
1    78	0011  B4 09			     mov     ah,9h
1    79	0013  CD 21			     int     21h
     80
     81	0015  B0 00			     mov     al,00h
     82	0017  B9 0009			     mov     cx,9
     83	001A  BA 0001			     mov     dx,1
     84	001D  BB 1C00r			     lea     bx,fatbuff
     85	0020  CD 25			     int     25h		     ;get fat
     86	0022  73 03 E9 0157		     jc	     errhnd
     87	0027  9D			     popf
     88
     89	0028  B9 0002			     mov     cx,2
     90	002B  E8 0107			     call    getback
     91					     put     msg01+3
1    92	002E  BA 2E43r			     lea     dx,msg01+3
1    93	0031  B4 09			     mov     ah,9h
1    94	0033  CD 21			     int     21h
     95
     96	0035  B0 00			     mov     al,00
     97	0037  B9 000D			     mov     cx,13
     98	003A  BA 0013			     mov     dx,19
     99	003D  BB 0000r			     lea     bx,dirbuff
    100	0040  CD 25			     int     25h		     ;get directory
    101	0042  73 03 E9 0137		     jc	     errhnd
    102	0047  9D			     popf
    103
    104	0048  B9 0003			     mov     cx,3
    105	004B  E8 00E7			     call    getback
    106					     put     msg01+7
1   107	004E  BA 2E47r			     lea     dx,msg01+7
1   108	0051  B4 09			     mov     ah,9h
1   109	0053  CD 21			     int     21h
    110
    111					     put     msg1
1   112	0055  BA 2E4Cr			     lea     dx,msg1
1   113	0058  B4 09			     mov     ah,9h
1   114	005A  CD 21			     int     21h
Turbo Assembler	 Version 4.1	    11/22/03 20:45:03	    Page 3
E:\PROGRAMS\ASSEMBLY\ASS\FAT.asm



    115	005C  BA 2E00r			     lea     dx,fname
    116	005F  B4 0A			     mov     ah,0ah
    117	0061  CD 21			     int     21h
    118
    119	0063  E8 0062			     call    maknam1		     ;convert name to directory	format
    120
    121	0066  FC			     cld
    122	0067  BF 0000r			     lea     di,dirbuff
    123	006A  8B D7			     mov     dx,di
    124
    125	006C			     doagain:
    126	006C  B9 000B			     mov     cx,11
    127	006F  BE 2E0Fr			     lea     si,[actname]
    128	0072  F3> A6			     rep     cmpsb
    129	0074  74 0A			     je	     found
    130	0076  83 C2 20			     add     dx,32		     ;point to next dir	entry
    131	0079  8B FA			     mov     di,dx
    132	007B  75 EF			     jne     doagain
    133	007D  E9 00F5			     jmp     nfound
    134
    135
    136	0080			     found:
    137					     put     msg2
1   138	0080  BA 2E62r			     lea     dx,msg2
1   139	0083  B4 09			     mov     ah,9h
1   140	0085  CD 21			     int     21h
    141	0087  83 C7 0F			     add     di,0fh		     ;point di to first	cluster
    142	008A  8B 05			     mov     ax,[di]
    143	008C  A3 2E1Er			     mov     clust,ax
    144	008F  E8 00AE			     call    dispnum
    145
    146	0092  B9 0003			     mov     cx,3h
    147	0095			     nextcluster:
    148	0095  F7 E1			     mul     cx
    149	0097  D1 E8			     shr     ax,1		     ;multiply by 1.5
    150
    151	0099  BE 1C00r			     lea     si,fatbuff		     ;reset si
    152	009C  03 F0			     add     si,ax
    153	009E  8B 04			     mov     ax,[si]
    154
    155	00A0  F7 06 2E1Er 0001		     test    clust,01b		     ;check for	even/odd
    156	00A6  74 0A			     jz	     eve
    157	00A8  D1 E8 D1 E8 D1 E8	D1+	     shr     ax,4	     ;use first	three
    158	      E8
    159	00B0  EB 03			     jmp     cont
    160
    161	00B2			     eve:
    162	00B2  25 0FFF			     and     ax,0fffh	     ;use last three
    163	00B5			     cont:
    164	00B5  E8 0088			     call    dispnum
    165	00B8  A3 2E1Er			     mov     clust,ax	     ;save for later
    166
    167	00BB  3D 0FF8			     cmp     ax,0ff8h
    168	00BE  72 D5			     jb	     nextcluster
    169	00C0  3D 0FFF			     cmp     ax,0fffh
    170	00C3  77 D0			     ja	     nextcluster
    171	00C5  E9 00D8			     jmp     quit
Turbo Assembler	 Version 4.1	    11/22/03 20:45:03	    Page 4
E:\PROGRAMS\ASSEMBLY\ASS\FAT.asm



    172
    173				     ;##############################PROCEDURES##############################
    174
    175	00C8			     maknam1 proc			     ;PROCEDURE	TO CONVERT THE FILENAME	INTO DIRECTORY FORMAT
    176	00C8  33 F6			     xor     si,si
    177	00CA  33 C9			     xor     cx,cx
    178	00CC  BF 2E02r			     lea     di,fname+2
    179	00CF			     @@make:
    180	00CF  8A 05			     mov     al,[di]
    181	00D1  3C 61			     cmp     al,61h
    182	00D3  72 06			     jb	     @@cont
    183	00D5  3C 7A			     cmp     al,7ah
    184	00D7  77 02			     ja	     @@cont
    185	00D9  24 DF			     and     al,11011111b
    186	00DB			     @@cont:
    187	00DB  3C 2E			     cmp     al,'.'
    188	00DD  74 15			     je	     @@padspace
    189	00DF  88 84 2E0Fr		     mov     [actname+si],al
    190	00E3  46			     inc     si
    191	00E4  41			     inc     cx
    192	00E5			     @@continue:
    193	00E5  47			     inc     di			     ;skip the dot
    194	00E6  80 F9 0B			     cmp     cl,11		     ;upto filename length
    195	00E9  75 E4			     jne     @@make
    196
    197	00EB  80 3E 2E01r 0C		     cmp     [fname+1],12
    198	00F0  75 10			     jne     @@adjust
    199	00F2  EB 40			     jmp     finish
    200
    201	00F4			     @@padspace:
    202	00F4  C6 06 2E20r 00		     mov     dotflag,0		     ;dot is present
    203	00F9  83 F9 08			     cmp     cx,8h
    204	00FC  74 E7			     je	     @@continue
    205	00FE  46			     inc     si
    206	00FF  41			     inc     cx
    207	0100  EB F2			     jmp     @@padspace
    208
    209	0102			     @@adjust:
    210	0102  33 F6			     xor     si,si
    211	0104  B9 0008			     mov     cx,8
    212	0107  BF 2E0Fr			     lea     di,[actname]
    213	010A  B0 20			     mov     al,20H
    214	010C			     @@1:
    215	010C  3A 05			     cmp     al,[di]
    216	010E  75 01			     jne     @@ninc
    217	0110  46			     inc     si
    218	0111			     @@ninc:
    219	0111  47			     inc     di
    220	0112  49			     dec     cx
    221	0113  75 F7			     jnz     @@1
    222
    223	0115  33 C9			     xor     cx,cx
    224	0117  8A 0E 2E01r		     mov     cl,[fname+1]
    225	011B  80 E9 0C			     sub     cl,12
    226	011E  02 0E 2E20r		     add     cl,dotflag		     ;no offect	if dot present
    227	0122  03 CE			     add     cx,si
    228
Turbo Assembler	 Version 4.1	    11/22/03 20:45:03	    Page 5
E:\PROGRAMS\ASSEMBLY\ASS\FAT.asm



    229	0124  BE 2E19r			     lea     si,[actname+10]
    230	0127			     @@append:
    231	0127  80 F9 00			     cmp     cl,0
    232	012A  7D 08			     jge     finish
    233	012C  C6 04 20			     mov     byte ptr [si],20h
    234	012F  4E			     dec     si
    235	0130  FE C1			     inc     cl
    236	0132  EB F3			     jmp     @@append
    237
    238	0134			     finish:
    239	0134  C3			     ret
    240	0135			     maknam1 endp
    241
    242	0135			     getback proc
    243	0135  B4 02			     mov     ah,02h
    244	0137  BA 0008			     mov     dx,8h
    245	013A  CD 21			     int     21h
    246	013C  49			     dec     cx
    247	013D  75 F6			     jnz     getback
    248	013F  C3			     ret
    249	0140			     getback endp
    250
    251	0140			     dispnum proc    ;uses ax dx cx si		 ; procedure to	convert	16 bit hex no.
    252	0140  50			     push    ax
    253	0141  51			     push    cx
    254	0142  52			     push    dx
    255	0143  56			     push    si
    256
    257	0144  B9 0010			     mov     cx,10h
    258	0147  33 F6			     xor     si,si
    259	0149			     @@normal:
    260	0149  33 D2			     xor     dx,dx
    261	014B  F7 F1			     div     cx
    262	014D  52			     push    dx
    263	014E  46			     inc     si
    264	014F  83 FE 04			     cmp     si,4
    265	0152  75 F5			     jne     @@normal
    266
    267	0154			     popagain:
    268	0154  5A			     pop     dx
    269	0155  80 FA 09			     cmp     dl,9
    270	0158  77 05			     ja	     char
    271	015A  80 C2 30			     add     dl,30h
    272	015D  EB 03			     jmp     skip
    273	015F			     char:
    274	015F  80 C2 37			     add     dl,37h
    275	0162			     skip:
    276	0162  B4 02			     mov     ah,02h
    277	0164  CD 21			     int     21h
    278	0166  4E			     dec     si
    279	0167  75 EB			     jnz     popagain
    280
    281					     put     crlf1
1   282	0169  BA 2EF0r			     lea     dx,crlf1
1   283	016C  B4 09			     mov     ah,9h
1   284	016E  CD 21			     int     21h
    285
Turbo Assembler	 Version 4.1	    11/22/03 20:45:03	    Page 6
E:\PROGRAMS\ASSEMBLY\ASS\FAT.asm



    286	0170  5E			     pop     si
    287	0171  5A			     pop     dx
    288	0172  59			     pop     cx
    289	0173  58			     pop     ax
    290
    291	0174  C3			     ret
    292	0175			     dispnum endp
    293
    294
    295				     ;#########################################ERROR HANDLER############
    296	0175			     nfound:
    297					     put     err3
1   298	0175  BA 2ED3r			     lea     dx,err3
1   299	0178  B4 09			     mov     ah,9h
1   300	017A  CD 21			     int     21h
    301	017C  EB 22			     jmp     quit
    302
    303	017E			     errhnd:
    304	017E  80 FC 80			     cmp     ah,80h
    305	0181  74 09			     je	     known
    306					     put     err2
1   307	0183  BA 2EB8r			     lea     dx,err2
1   308	0186  B4 09			     mov     ah,9h
1   309	0188  CD 21			     int     21h
    310	018A  EB 14			     jmp     quit
    311
    312	018C			     known:
    313					     put     err1
1   314	018C  BA 2E7Er			     lea     dx,err1
1   315	018F  B4 09			     mov     ah,9h
1   316	0191  CD 21			     int     21h
    317	0193  32 E4			     xor     ah,ah
    318	0195  CD 16			     int     16h
    319	0197  FE 0E 2E1Dr		     dec     cnt
    320	019B  74 03			     jz	     quit
    321	019D  E9 FE67			     jmp     tryagain
    322
    323	01A0			     quit:
    324	01A0  B8 4C00			     mov     ax,4c00h
    325	01A3  CD 21			     int     21h
    326				     end     start
Turbo Assembler	 Version 4.1	    11/22/03 20:45:03	    Page 7
Symbol Table




Symbol Name		Type   Value			   Cref	(defined at #)

??DATE			Text   "11/22/03"
??FILENAME		Text   "FAT	"
??TIME			Text   "20:45:03"
??VERSION		Number 040A
@32BIT			Text   0			   #11
@@1			Near   _TEXT:010C		   #214	 221
@@ADJUST		Near   _TEXT:0102		   198	#209
@@APPEND		Near   _TEXT:0127		   #230	 236
@@CONT			Near   _TEXT:00DB		   182	184  #186
@@CONTINUE		Near   _TEXT:00E5		   #192	 204
@@MAKE			Near   _TEXT:00CF		   #179	 195
@@NINC			Near   _TEXT:0111		   216	#218
@@NORMAL		Near   _TEXT:0149		   #259	 265
@@PADSPACE		Near   _TEXT:00F4		   188	#201  207
@CODE			Text   _TEXT			   #11	#11  #65
@CODESIZE		Text   0			   #11
@CPU			Text   0101H
@CURSEG			Text   _TEXT			   #13	#65
@DATA			Text   DGROUP			   #11	67
@DATASIZE		Text   0			   #11
@FILENAME		Text   FAT
@INTERFACE		Text   000H			   #11
@MODEL			Text   2			   #11
@STACK			Text   DGROUP			   #11
@WORDSIZE		Text   2			   #13	#65
ACTNAME			Byte   DGROUP:2E0F		   #17	127  189  212  229
CHAR			Near   _TEXT:015F		   270	#273
CLUST			Word   DGROUP:2E1E		   #19	143  155  165
CNT			Byte   DGROUP:2E1D		   #18	319
CONT			Near   _TEXT:00B5		   159	#163
CRLF1			Byte   DGROUP:2EF0		   #57	282
DIRBUFF			Byte   DGROUP:0000		   #14	99  122
DISPNUM			Near   _TEXT:0140		   144	164  #251
DOAGAIN			Near   _TEXT:006C		   #125	 132
DOTFLAG			Byte   DGROUP:2E20		   #21	202  226
ERR1			Byte   DGROUP:2E7E		   #39	314
ERR2			Byte   DGROUP:2EB8		   #48	307
ERR3			Byte   DGROUP:2ED3		   #52	298
ERRHND			Near   _TEXT:017E		   86  101  #303
EVE			Near   _TEXT:00B2		   156	#161
FATBUFF			Byte   DGROUP:1C00		   #15	84  151
FINISH			Near   _TEXT:0134		   199	232  #238
FNAME			Byte   DGROUP:2E00		   #16	115  178  197  224
FOUND			Near   _TEXT:0080		   129	#136
GETBACK			Near   _TEXT:0135		   90  105  #242  247
KNOWN			Near   _TEXT:018C		   305	#312
MAKNAM1			Near   _TEXT:00C8		   119	#175
MSG0			Byte   DGROUP:2E21		   #22	73
MSG01			Byte   DGROUP:2E40		   #27	77  92	107
MSG1			Byte   DGROUP:2E4C		   #29	112
MSG2			Byte   DGROUP:2E62		   #33	138
MSG3			Byte   DGROUP:2E6F		   #35
NEXTCLUSTER		Near   _TEXT:0095		   #147	 168  170
NFOUND			Near   _TEXT:0175		   133	#296
Turbo Assembler	 Version 4.1	    11/22/03 20:45:03	    Page 8
Symbol Table



POPAGAIN		Near   _TEXT:0154		   #267	 279
QUIT			Near   _TEXT:01A0		   171	301  310  320  #323
SKIP			Near   _TEXT:0162		   272	#275
START			Near   _TEXT:0000		   #66	326
TRYAGAIN		Near   _TEXT:0007		   #71	321

Macro Name						   Cref	(defined at #)

PUT							   #59	72  76	91  106	 111  137  281	297  306  313

Groups & Segments	Bit Size Align	Combine	Class	   Cref	(defined at #)

DGROUP			Group				   #11	11  67
  STACK			16  0400 Para	Stack	STACK	   #12
  _DATA			16  2EF3 Word	Public	DATA	   #11	#13
_TEXT			16  01A5 Word	Public	CODE	   #11	11  #65	 65
