Turbo Assembler	 Version 4.1	    12/20/03 21:07:44	    Page 1
H:\programs\ASSEMBLY\ASS\P.asm



      1				     ;	  Printer Device Drivers
      2				     ; ===============================
      3
      4
      5	0000			     .model small
      6	0000			     .code
      7					     org 0
      8	0000			     begin :
      9
     10				     ;---------------- Variables --------------------------------
     11
     12	0000  FFFFFFFF		     header	     dd	     -1		; linking to next d. driver
     13	0004  8000				     dw	     8000h	; char d. driver
     14	0006  0016r				     dw	     strat	; offset of strategy routine
     15	0008  0021r				     dw	     intr	; offset of interrupt routine
     16	000A  50 5F 50 52 49 4E	54+		     db	     'P_PRINT '	; logical device name
     17	      20
     18
     19	0012  ????????		     rhptr	     dd	     ?		; request header pointer
     20
     21
     22				     ;-----------------	Strategy Routine ------------------------
     23
     24	0016			     strat proc	far
     25
     26	0016  2E: 89 1E	0012r		     mov word ptr cs:[rhptr], bx
     27	001B  2E: 8C 06	0014r		     mov word ptr cs:[rhptr+2],	es
     28	0020  CB			     ret
     29
     30	0021			     strat endp
     31
     32				     ;------------------ Interrupt Routine ----------------------
     33
     34	0021			     intr proc far
     35
     36	0021  50			     push ax		     ; saving registers
     37	0022  53			     push bx
     38	0023  51			     push cx
     39	0024  52			     push dx
     40	0025  56			     push si
     41	0026  57			     push di
     42	0027  06			     push es
     43	0028  1E			     push ds
     44	0029  55			     push bp
     45
     46	002A  0E			     push cs
     47	002B  1F			     pop  ds
     48
     49	002C  2E: C4 3E	0012r		     les di , [rhptr]
     50
     51	0031  26: 8A 5D	02		     mov bl, es:[di+2]	     ; Get command code
     52	0035  32 FF			     xor bh, bh
     53	0037  83 FB 18			     cmp bx, 24		     ; Check if	it is valid
     54	003A  7E 05			     jle intr1
     55	003C  E8 0097			     call Error
     56	003F  EB 3F			     jmp intrn
     57
Turbo Assembler	 Version 4.1	    12/20/03 21:07:44	    Page 2
H:\programs\ASSEMBLY\ASS\P.asm



     58	0041			     intr1 :			     ; Init. device driver
     59	0041  80 FB 00			     cmp bl,00
     60	0044  75 05			     jne intr2
     61	0046  E8 00FD			     call initz
     62	0049  EB 35			     jmp intrn
     63
     64	004B			     intr2 :
     65	004B  80 FB 01			     cmp bl, 01		     ; Media Check
     66	004E  75 05			     jne intr3
     67	0050  E8 003F			     call mediachk
     68	0053  EB 2B			     jmp intrn
     69
     70	0055			     intr3 :
     71	0055  80 FB 02			     cmp bl, 02		     ; Build BPB
     72	0058  75 05			     jne intr4
     73	005A  E8 0038			     call bpb
     74	005D  EB 21			     jmp intrn
     75
     76	005F			     intr4 :
     77	005F  80 FB 08			     cmp bl, 08		     ; Write o/p
     78	0062  75 05			     jne intr6
     79	0064  E8 0031			     call write
     80	0067  EB 17			     jmp intrn
     81
     82	0069			     intr6 :
     83	0069  80 FB 0A			     cmp bl, 10		     ; Output status
     84	006C  75 05			     jne intr7
     85	006E  E8 004F			     call outstat
     86	0071  EB 0D			     jmp intrn
     87
     88	0073			     intr7 :
     89	0073  80 FB 0B			     cmp bl, 11		     ; Flush output buffers
     90	0076  75 05			     jne intr8
     91	0078  E8 0058			     call flushbuff
     92	007B  EB 03			     jmp intrn
     93
     94	007D			     intr8 :
     95	007D  E8 0056			     call Error
     96	0080			     intrn :
     97	0080  81 CB 0100		     or	bx, 0100h	  ; merge 'Done' bit into status &
     98	0084  26: 89 5D	03		     mov es:[di+3], bx	  ; store status word in R.H.
     99
    100	0088  5D			     pop bp
    101	0089  1F			     pop ds
    102	008A  07			     pop es
    103	008B  5F			     pop di
    104	008C  5E			     pop si
    105	008D  5A			     pop dx
    106	008E  59			     pop cx
    107	008F  5B			     pop bx
    108	0090  58			     pop ax
    109	0091  CB			     ret
    110
    111	0092			     intr endp
    112
    113				     ;-----------------------------------------------------------
    114
Turbo Assembler	 Version 4.1	    12/20/03 21:07:44	    Page 3
H:\programs\ASSEMBLY\ASS\P.asm



    115	0092			     mediachk proc near
    116	0092  33 DB			     xor bx ,bx
    117	0094  C3			     ret
    118	0095			     mediachk endp
    119
    120				     ;-----------------------------------------------------------
    121
    122	0095			     bpb proc near
    123	0095  33 DB			     xor bx ,bx
    124	0097  C3			     ret
    125	0098			     bpb endp
    126
    127				     ;-----------------------------------------------------------
    128
    129	0098			     write proc	near
    130
    131	0098  06			     push es
    132	0099  57			     push di
    133
    134	009A  2E: C4 3E	0020r		     les di, [rhptr+14]		 ; memory address for transfer
    135	009F  26: 8B 4D	12		     mov cx, word ptr es:[di+18] ; size	in bytes per sector
    136
    137	00A3			     printch :
    138	00A3  B4 00			     mov ah,00
    139	00A5  26: 8A 05			     mov al, byte ptr es:[di]
    140	00A8  BA 0000			     mov dx, 00
    141	00AB  CD 17			     int 17h
    142
    143	00AD  F6 C4 29			     test ah, 00101001b
    144	00B0  75 08			     jnz err_ret
    145	00B2  47			     inc di
    146	00B3  E2 EE			     loop printch
    147
    148	00B5  5F			     pop di
    149	00B6  07			     pop es
    150	00B7  33 DB			     xor bx, bx
    151	00B9  C3			     ret
    152	00BA			     err_ret :
    153	00BA  5F			     pop di
    154	00BB  07			     pop es
    155	00BC  BB 800A			     mov bx, 800ah	     ; 0a -> error  : write fault
    156	00BF  C3			     ret
    157
    158	00C0			     write endp
    159
    160				     ;-----------------------------------------------------------
    161
    162	00C0			     outstat proc near
    163
    164	00C0  B4 02			     mov ah, 02
    165	00C2  BA 0000			     mov dx, 00
    166	00C5  CD 17			     int 17h
    167
    168	00C7  F6 C4 29			     test ah, 00101001b
    169	00CA  75 03			     jnz err_ret01
    170
    171	00CC  33 DB			     xor bx, bx
Turbo Assembler	 Version 4.1	    12/20/03 21:07:44	    Page 4
H:\programs\ASSEMBLY\ASS\P.asm



    172	00CE  C3			     ret
    173
    174	00CF			     err_ret01 :
    175	00CF  BB 0200			     mov bx, 0200h	   ; set busy bit-9 in status word
    176	00D2  C3			     ret
    177
    178	00D3			     outstat endp
    179
    180
    181				     ;-----------------------------------------------------------
    182
    183	00D3			     flushbuff proc near
    184	00D3  33 DB			     xor bx, bx
    185	00D5  C3			     ret
    186	00D6			     flushbuff endp
    187
    188				     ;-----------------------------------------------------------
    189
    190	00D6			     Error proc	near
    191	00D6  BB 8003			     mov bx, 8003h	     ;03 -> Unknown command
    192	00D9  C3			     ret
    193	00DA			     Error  endp
    194
    195				     ;-----------------------------------------------------------
    196
    197	00DA  0D 0A		     msg_init	     db	     13,10
    198	00DC  C9 CD CD CD CD CD	CD+		     db	     'ษอออออออออออออออออออออออออออออออป',13,10
    199	      CD CD CD CD CD CD	CD+
    200	      CD CD CD CD CD CD	CD+
    201	      CD CD CD CD CD CD	CD+
    202	      CD CD CD CD BB 0D	0A
    203	00FF  BA 20 20 20 20 50	72+		     db	     'บ	   Printer Driver Installed   บ',13,10
    204	      69 6E 74 65 72 20	44+
    205	      72 69 76 65 72 20	49+
    206	      6E 73 74 61 6C 6C	65+
    207	      64 20 20 20 BA 0D	0A
    208	0122  C8 CD CD CD CD CD	CD+		     db	     'ศอออออออออออออออออออออออออออออออผ',13,10,'$'
    209	      CD CD CD CD CD CD	CD+
    210	      CD CD CD CD CD CD	CD+
    211	      CD CD CD CD CD CD	CD+
    212	      CD CD CD CD BC 0D	0A+
    213	      24
    214
    215				     ;-----------------------------------------------------------
    216
    217	0146			     initz proc	near
    218
    219	0146  B4 01			     mov ah, 01		     ; Init printer
    220	0148  BA 0000			     mov dx, 00
    221	014B  CD 17			     int 17h
    222
    223	014D  80 FC 10			     cmp ah, 10h
    224	0150  74 1A			     je	Ok
    225
    226				     ; Now , an	error has occured.
    227				     ; Abort installation
    228
Turbo Assembler	 Version 4.1	    12/20/03 21:07:44	    Page 5
H:\programs\ASSEMBLY\ASS\P.asm



    229	0152  2E: 81 26	0004r 8000	     and word ptr [header+4],8000h   ; Set Bit-15 of attribute
    230									     ; word in header
    231	0159  26: C7 45	0D 0000		     mov word ptr es:[di+13],00
    232	015F  26: C7 45	0E 0000		     mov word ptr es:[di+14],00
    233	0165  26: 8C 4D	10		     mov word ptr es:[di+16],cs	     ; Break Addr = CS:0000
    234	0169  33 DB			     xor bx,bx
    235	016B  C3			     ret
    236
    237	016C			     Ok:
    238	016C  B4 09			     mov ah , 09
    239	016E  BA 00DAr			     lea dx , msg_init
    240	0171  CD 21			     int 21h
    241
    242	0173  26: C7 45	0E 0146r	     mov word ptr es:[di+14], offset initz  ; Break address
    243	0179  26: 8C 4D	10		     mov word ptr es:[di+16], cs
    244	017D  C3			     ret
    245
    246	017E			     initz endp
    247
    248				     ;-----------------------------------------------------------------
    249
    250				     end begin
Turbo Assembler	 Version 4.1	    12/20/03 21:07:44	    Page 6
Symbol Table




Symbol Name		Type   Value			   Cref	(defined at #)

??DATE			Text   "12/20/03"
??FILENAME		Text   "P	"
??TIME			Text   "21:07:44"
??VERSION		Number 040A
@32BIT			Text   0			   #5
@CODE			Text   _TEXT			   #5  #5  #6
@CODESIZE		Text   0			   #5
@CPU			Text   0101H
@CURSEG			Text   _TEXT			   #6
@DATA			Text   DGROUP			   #5
@DATASIZE		Text   0			   #5
@FILENAME		Text   P
@INTERFACE		Text   000H			   #5
@MODEL			Text   2			   #5
@STACK			Text   DGROUP			   #5
@WORDSIZE		Text   2			   #6
BEGIN			Near   _TEXT:0000		   #8  250
BPB			Near   _TEXT:0095		   73  #122
ERROR			Near   _TEXT:00D6		   55  95  #190
ERR_RET			Near   _TEXT:00BA		   144	#152
ERR_RET01		Near   _TEXT:00CF		   169	#174
FLUSHBUFF		Near   _TEXT:00D3		   91  #183
HEADER			Dword  _TEXT:0000		   #12	229
INITZ			Near   _TEXT:0146		   61  #217  242
INTR			Far    _TEXT:0021		   15  #34
INTR1			Near   _TEXT:0041		   54  #58
INTR2			Near   _TEXT:004B		   60  #64
INTR3			Near   _TEXT:0055		   66  #70
INTR4			Near   _TEXT:005F		   72  #76
INTR6			Near   _TEXT:0069		   78  #82
INTR7			Near   _TEXT:0073		   84  #88
INTR8			Near   _TEXT:007D		   90  #94
INTRN			Near   _TEXT:0080		   56  62  68  74  80  86  92  #96
MEDIACHK		Near   _TEXT:0092		   67  #115
MSG_INIT		Byte   _TEXT:00DA		   #197	 239
OK			Near   _TEXT:016C		   224	#237
OUTSTAT			Near   _TEXT:00C0		   85  #162
PRINTCH			Near   _TEXT:00A3		   #137	 146
RHPTR			Dword  _TEXT:0012		   #19	26  27	49  134
STRAT			Far    _TEXT:0016		   14  #24
WRITE			Near   _TEXT:0098		   79  #129

Groups & Segments	Bit Size Align	Combine	Class	   Cref	(defined at #)

DGROUP			Group				   #5  5
  _DATA			16  0000 Word	Public	DATA	   #5
_TEXT			16  017E Word	Public	CODE	   #5  5  #6  6
